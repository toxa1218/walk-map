<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞—Ä—Ç–∞ –ü—Ä–æ–≥—É–ª–æ–∫</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.expand(); // –†–∞—Å–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ú–æ—Å–∫–≤–∞, –Ω–æ –æ–Ω —Å–¥–≤–∏–Ω–µ—Ç—Å—è)
    const map = L.map('map').setView([55.75, 37.61], 13);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –∫–∞—Ä—Ç—ã (OpenStreetMap - –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ URL
    function getParams() {
        const params = new URLSearchParams(window.location.search);
        const data = params.get('data');
        return data ? JSON.parse(decodeURIComponent(data)) : [];
    }

    // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç–∞–≤–∏–º –º–µ—Ç–∫–∏
    const events = getParams();
    const markers = [];

    events.forEach(event => {
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
        const marker = L.marker([event.lat, event.lon]).addTo(map);
        
        // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
        const popupContent = `
            <b>${event.desc}</b><br>
            ‚è∞ ${event.time}<br>
            üè∑ ${event.tags}<br>
            <button onclick="sendBack(${event.id})" style="margin-top:5px; padding:5px; width:100%; cursor:pointer;">–ü–æ–π—Ç–∏!</button>
        `;
        
        marker.bindPopup(popupContent);
        markers.push(marker);
    });

    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Ç–∫–∏, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö –≤—Å–µ
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–Ω–æ –±–æ—Ç—É (–ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ü–æ–π—Ç–∏")
    function sendBack(eventId) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
        tg.sendData(JSON.stringify({action: "join", id: eventId}));
        tg.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
    }
</script>

</body>
</html>